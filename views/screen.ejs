<%- include("partials/head.ejs") %>

<p><a href="/screen/deleted">View (and restore) deleted screens</a></p>


<p><input type="button" value="Create New Screen" onclick="window.vueApp.new()" /></p>



	<dialog id="editDialog">
		<h3>Edit Screen</h3>
		<form method=dialog>
			<div id="app">
				<input type=hidden v-model="ScreenId">
				<label for=number>Number</label> <input id=number v-model="number"><br>
				<label for=colour>Colour</label> <input id=colour v-model="Colour"><br>
				<label for=name>Name</label> <input id=name v-model="Name"><br>
				<p>
					<button id="saveButton" value="default" @click="save">Save</button>&emsp;
					<input type=button value="Cancel" onclick="this.closest('dialog').close()" />
				</p>
			</div>
		</form>
	</dialog>

	<table id="datatable" class="stripe hover">
		<thead>
			<tr>
				<th></th>
				<th>Number</th>
				<th>Colour</th>
				<th>Name</th>
				<th>Last Used</th>
			</tr>
		</thead>

	</table>


		<script>


			window.datatable = new DataTable("#datatable", {
				processing: true,
				serverSide: true,
				ajax: "/screen/dt",
				language: {
					searchPlaceholder: "Search number, colour or name"
				},
				order: [[3, 'asc']],
				columns: [
					{
						orderable: false,
						data: "ScreenId",
						render(data) {
							return `<a href=# class=editLink><span class="fa fa-edit fa-lg" title=Edit></span></a>&emsp;
							<a href=# class=deleteLink><span class="fa fa-trash fa-lg" title=Delete>`
						}
					},
					{ data: "Number" },
					{ data: "Colour" },
					{ data: "Name" },
					{ 
						data: "LastUsed",
						render: function(data) {
							const ts = Date.parse(data)
							if (isNaN(ts))
								return ""
							return new Date(ts).toLocaleDateString()

						}  
					}
				]
			})

			$("#datatable tbody").on("click", "a.editLink", function () {
				event.preventDefault()
				var tr = this.closest("tr")
				var row = window.datatable.row(tr)
				console.log(row.data())
				const data = row.data()
				window.vueApp.setData(data)
				const editDialog = document.getElementById("editDialog")
				editDialog.querySelector("h3").textContent = "Edit screen"
				editDialog.showModal()
			})

			$("#datatable tbody").on("click", "a.deleteLink", function () {
				event.preventDefault()
				var tr = this.closest("tr")
				var row = window.datatable.row(tr)
				console.log(row.data())
				const data = row.data()

				try {
					fetch(`/screen/${data.ScreenId}`, {
						method: "DELETE"
					})
						.then(response => {
							if (response.ok)
								return response.json()
							else
								throw new Error(response.statusText)
						})
						.then(json => window.datatable.ajax.reload(null, false) )
						.catch(error => window.alert(`We encountered an error: ${json.error}`))
				}
				catch (err) {
					window.alert("We encountered an error: " + err.message)
				}
			})



			window.vueApp = Vue.createApp({
				data() {
					return {
						ScreenId: 0,
						number: "",
						Colour: "",
						Name: ""
					}
				},
				methods: {
					setData(data) {
						this.ScreenId = data.ScreenId
						this.number = data.Number
						this.Colour = data.Colour
						this.Name = data.Name
					},
					save() {
						let body = JSON.parse(JSON.stringify(this.$data))
						body.Number = body.number
						delete body.number
						try {
							let method = "POST" 
							let url = "/screen"
							if (this.ScreenId > 0) {
								method = "PUT"
								url += `/${this.ScreenId}`
							}
							fetch(url, {
								method,
								headers: new Headers({
									"Content-Type": "application/json"
								}),
								body: JSON.stringify(body)
							})
							.then(response => {
								if (response.ok)
									return response.json()
								else
									throw new Error(response.statusText)
							})
							.then(json => {
								window.datatable.ajax.reload(null, window.vueApp.ScreenId == 0)// reset paging if it's a new item
								//document.getElementById("editDialog").close()
							})
							.catch(error => window.alert(`We encountered an error: ${error}`))
						}
						catch (err) {
							window.alert("We encountered an error: " + err.message)
						}

					},
					new() {
						this.ScreenId = 0
						this.number = ""
						this.Colour = ""
						this.Name = ""
						const editDialog = document.getElementById("editDialog")
						editDialog.querySelector("h3").textContent = "New screen"
						editDialog.showModal()
					}
				}
			}).mount("#app")


		</script>



		<%- include("partials/foot.ejs") %>